<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Neural Trade Station</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Courier New', monospace; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .panel { background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .row { display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap; }
        
        label { font-size: 12px; color: #888; display: block; margin-bottom: 5px; }
        input { background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        
        /* Fixed Disabled Style */
        input:disabled { background: #222; color: #555 !important; border-color: #444; cursor: not-allowed; } 
        
        button { background: #333; border: 1px solid #555; color: white; padding: 8px 16px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        button:hover { background: #444; }
        button.primary { background: #00e676; border: none; color: black; }
        button.danger { background: #ff3d00; border: none; color: black; }
        button.secondary { background: #444; border: 1px solid #666; color: white; }
        
        .balance-card { background: #263238; padding: 10px 20px; border-radius: 4px; border: 1px solid #37474f; min-width: 150px; }
        .balance-val { font-size: 20px; font-weight: bold; color: #00e676; }

        .log-box { background: #000; padding: 10px; height: 300px; overflow-y: auto; border: 1px solid #333; font-size: 12px; font-family: monospace; }
        .log-entry { border-bottom: 1px solid #222; padding: 4px 0; }
        
        /* --- NEW COLORS --- */
        .log-buy { color: #29b6f6; }   /* Blue for Buys (Easier to distinguish) */
        .log-profit { color: #00e676; font-weight: bold; } /* Green for Profit */
        .log-loss { color: #ff3d00; font-weight: bold; }   /* Red for Loss */
        /* ------------------ */
        
        .live-indicator { height: 10px; width: 10px; background: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .live-active { background: #00e676; box-shadow: 0 0 10px #00e676; }
    </style>
</head>
<body>

<div class="container">
    <h1>ü§ñ Neural Trade Station</h1>

    <div class="panel">
        <div class="row">
            <div>
                <label>Token</label>
                <div style="display:flex; gap:10px;">
                    <input type="password" id="tokenInput" placeholder="Bearer eyJ...">
                    <button onclick="saveToken()">Save</button>
                </div>
            </div>
            <div class="balance-card">
                <label>Joint Cash</label>
                <div id="balanceDisplay" class="balance-val">---</div>
                <button onclick="checkBalance()" style="font-size:10px; padding:2px 8px; margin-top:5px;">Refresh</button>
            </div>
            <div>
                <label>Target Stock</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="tickerInput" value="INTC" style="width: 80px; text-align: center;">
                    <button class="secondary" onclick="updateDataset()" title="Download Training Data" style="padding: 0 12px;">‚¨áÔ∏è</button>
                </div>
            </div>
            <div>
                <label>Trade Amount ($)</label>
                <input type="number" id="tradeAmount" value="10" style="width: 80px; text-align: center; color: #00e676; font-weight: bold;">
            </div>
            <div>
                <label>Check Interval (min)</label>
                <input type="number" id="tradeInterval" value="1" min="1" style="width: 80px; text-align: center;">
            </div>
        </div>
    </div>

    <div class="panel" style="border: 1px solid #00e676;">
        <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin:0;"><span id="liveDot" class="live-indicator"></span> Live Trader</h2>
            <div>
                <button id="startBtn" class="primary" onclick="toggleTrading('start')">‚ñ∂Ô∏è START LIVE TRADING</button>
                <button id="stopBtn" class="danger" onclick="toggleTrading('stop')" style="display:none;">‚èπ STOP BOT</button>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label>Status</label>
                <div id="botStatus" style="font-size: 14px; color: #aaa; margin-bottom: 10px;">Idle</div>
                <label>Last Check</label>
                <div id="lastCheck" style="font-size: 18px; color: white;">---</div>
            </div>
            <div>
                <label>Live Logs</label>
                <div class="log-box" id="liveLogs"></div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2>üî¨ Backtest Simulation <span id="simResult" style="font-size: 18px; margin-left: 15px;"></span></h2>
        </div>
        
        <button onclick="runSim()">Run Simulation on Historical Data</button>
        <div class="log-box" id="simLogs" style="height: 150px; margin-top: 10px; border-color: #444;"></div>
    </div>
</div>

<script>
    let poller = null;

    // --- DATA MANAGEMENT ---
    async function updateDataset() {
        const ticker = document.getElementById('tickerInput').value;
        const logBox = document.getElementById('simLogs'); 
        logBox.innerHTML = `<div class="log-entry">‚è≥ Downloading fresh data for ${ticker}...</div>`;
        
        try {
            const res = await fetch('/update_dataset', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ticker: ticker })
            });
            const data = await res.json();
            
            if(data.success) {
                const rowCount = (data.rows !== undefined) ? data.rows : 0;
                const period = data.period_used || "unknown";
                logBox.innerHTML += `<div class="log-entry log-buy">‚úÖ Success! Downloaded ${rowCount} rows (${period}).</div>`;
                alert(`Data for ${ticker} downloaded successfully!`);
            } else {
                logBox.innerHTML += `<div class="log-entry log-loss">‚ùå Error: ${data.msg || data.error}</div>`;
            }
        } catch (e) {
            logBox.innerHTML += `<div class="log-entry log-loss">‚ùå Network Error: ${e}</div>`;
        }
    }

    // --- LIVE TRADING FUNCTIONS ---
    async function toggleTrading(action) {
        const ticker = document.getElementById('tickerInput').value;
        const amount = document.getElementById('tradeAmount').value;
        const interval = document.getElementById('tradeInterval').value;
        
        const res = await fetch('/toggle_trading', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                action: action, 
                ticker: ticker,
                amount: amount,
                interval: interval 
            })
        });
        const data = await res.json();
        updateUI(data.active);
    }

    async function updateStatus() {
        const res = await fetch('/get_live_status');
        const state = await res.json();
        
        updateUI(state.active);
        document.getElementById('botStatus').innerText = state.status;
        if(state.last_update) document.getElementById('lastCheck').innerText = state.last_update;

        const logBox = document.getElementById('liveLogs');
        logBox.innerHTML = '';
        state.logs.forEach(msg => {
            logBox.innerHTML += `<div class="log-entry">${msg}</div>`;
        });
        logBox.scrollTop = logBox.scrollHeight;
    }

    function updateUI(active) {
        const inputs = [
            document.getElementById('tickerInput'),
            document.getElementById('tradeAmount'),
            document.getElementById('tradeInterval')
        ];

        if(active) {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('liveDot').classList.add('live-active');
            inputs.forEach(input => input.disabled = true);
            if(!poller) poller = setInterval(updateStatus, 5000); 
        } else {
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('liveDot').classList.remove('live-active');
            inputs.forEach(input => input.disabled = false);
            if(poller) { clearInterval(poller); poller = null; }
        }
    }

    // --- HELPERS ---
    async function checkBalance() {
        try {
            const res = await fetch('/get_balance');
            const data = await res.json();
            if(data.success) document.getElementById('balanceDisplay').innerText = "$" + data.cash.toFixed(2);
        } catch(e) {}
    }

    async function saveToken() {
        const token = document.getElementById('tokenInput').value;
        await fetch('/save_token', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token: token })
        });
        checkBalance();
        alert("Token Saved");
    }

    async function runSim() {
        const ticker = document.getElementById('tickerInput').value;
        const logBox = document.getElementById('simLogs');
        const resultSpan = document.getElementById('simResult');
        
        logBox.innerHTML = "Running...";
        resultSpan.innerText = ""; 
        
        const res = await fetch('/run_sim', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ticker: ticker })
        });
        const data = await res.json();
        
        logBox.innerHTML = "";
        
        if(data.logs) {
            data.logs.forEach(l => {
                // ADD COLOR CLASSES BASED ON TYPE
                let cls = "";
                if(l.type === 'buy') cls = "log-buy";
                if(l.type === 'profit') cls = "log-profit";
                if(l.type === 'loss') cls = "log-loss";
                
                logBox.innerHTML += `<div class="log-entry ${cls}">[${l.date}] ${l.msg}</div>`;
            });
            logBox.scrollTop = logBox.scrollHeight;

            if (data.bot_balance && data.bot_balance.length > 0) {
                const startCapital = 10000.0;
                const endCapital = data.bot_balance[data.bot_balance.length - 1];
                const profit = endCapital - startCapital;
                const pct = ((profit / startCapital) * 100).toFixed(2);
                
                let color = profit >= 0 ? "#00e676" : "#ff3d00";
                let sign = profit >= 0 ? "+" : "";
                
                resultSpan.innerHTML = `<span style="color:${color}">${sign}$${profit.toFixed(2)} (${sign}${pct}%)</span>`;
            }
        } else {
            logBox.innerHTML = "Error: " + (data.error || "Unknown");
        }
    }

    checkBalance();
</script>

</body>
</html>