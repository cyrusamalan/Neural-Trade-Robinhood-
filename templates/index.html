<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Trade Robinhood</title>
    <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .terminal-logs {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
            font-size: 0.9rem;
        }
        .log-buy { color: #4ade80; font-weight: bold; }
        .log-profit { color: #38bdf8; font-weight: bold; }
        .log-loss { color: #f87171; font-weight: bold; }
        .log-force { color: #fbbf24; font-weight: bold; }
        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="p-6">

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-blue-400">üß† Neural Trade Dashboard</h1>
            <p class="text-gray-400 text-sm">Robinhood API ‚Ä¢ Random Forest ‚Ä¢ Council of Strategies</p>
        </div>
        <div class="text-right">
            <div id="connection-status" class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                <span class="text-xs text-gray-500 uppercase">Token Status</span>
                <div class="font-bold text-green-400">{{ token_status }}</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6">
        
        <div class="col-span-3 space-y-4">
            
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <h3 class="font-bold text-gray-300 mb-2">1. Settings</h3>
                <label class="block text-xs text-gray-500 mb-1">TICKER</label>
                <input type="text" id="ticker-input" value="INTC" class="w-full bg-slate-900 border border-slate-600 rounded p-2 mb-3 text-white font-mono uppercase">
                
                <label class="block text-xs text-gray-500 mb-1">MODE</label>
                <select id="sim-mode" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white">
                    <option value="swing">üåä Swing (Daily)</option>
                    <option value="day">‚òÄÔ∏è Day (5-Min)</option>
                </select>
            </div>

            <button onclick="runSimulation()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition border border-blue-500">
                üî¨ Run Backtest
            </button>

            <div class="bg-slate-900 p-4 rounded-lg border border-indigo-900">
                <h3 class="font-bold text-indigo-400 mb-2">2. Live Bot Control</h3>
                
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm text-gray-400">Paper Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="paper-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>

                <button id="btn-start" onclick="toggleLiveBot()" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded transition mb-2">
                    ‚ñ∂Ô∏è Start Bot
                </button>
                
                <div id="live-indicator" class="hidden mt-2 text-center">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full status-pulse mr-2"></span>
                    <span class="text-xs text-red-400 font-mono" id="live-ticker-display">LIVE: INTC</span>
                </div>
            </div>

            <div id="balance-box" class="hidden bg-slate-900 p-4 rounded-lg border mt-4 text-center">
                <div class="text-gray-400 text-xs uppercase">Simulated Final Balance</div>
                <div id="final-balance-display" class="text-2xl font-bold">---</div>
                <div id="final-pct-display" class="text-sm font-bold">---</div>
            </div>
        </div>

        <div class="col-span-9 bg-slate-800 rounded-lg border border-slate-700 p-1">
            <div id="chart" class="w-full h-[400px]"></div>
        </div>

        <div class="col-span-12">
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 flex gap-4">
                
                <div class="w-1/2">
                    <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">Backtest Log</h3>
                    <div id="log-container" class="terminal-logs">
                        <div class="text-gray-500 italic">Waiting for simulation...</div>
                    </div>
                </div>

                <div class="w-1/2">
                    <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider flex justify-between">
                        <span>Live Bot Stream</span>
                        <span id="bot-hb" class="text-xs font-normal text-gray-600">Heartbeat: ---</span>
                    </h3>
                    <div id="live-logs" class="terminal-logs border-indigo-900 bg-[#161b22]">
                        <div class="text-gray-600 italic">Bot is offline.</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- 1. SIMULATION LOGIC ---
        async function runSimulation() {
            const ticker = document.getElementById('ticker-input').value;
            const mode = document.getElementById('sim-mode').value;
            const logBox = document.getElementById('log-container');

            logBox.innerHTML = '<div class="text-blue-400 animate-pulse">Running Simulation...</div>';

            try {
                const response = await fetch('/run_sim', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: ticker, mode: mode })
                });
                const data = await response.json();
                
                if (data.error) {
                    logBox.innerHTML = `<div class="text-red-500">Error: ${data.error}</div>`;
                    return;
                }
                renderLogs(data.logs, 'log-container');
                renderBalance(data.bot_balance);
                renderChart(data);
            } catch (e) { logBox.innerHTML = `<div class="text-red-500">Error: ${e}</div>`; }
        }

        // --- 2. LIVE BOT LOGIC ---
        let livePoller = null;
        let isBotActive = false;

        async function toggleLiveBot() {
            const btn = document.getElementById('btn-start');
            const ticker = document.getElementById('ticker-input').value;
            const mode = document.getElementById('sim-mode').value;
            const paper = document.getElementById('paper-toggle').checked;
            
            const action = isBotActive ? 'stop' : 'start';

            const response = await fetch('/toggle_trading', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action, ticker: ticker, mode: mode, paper: paper })
            });
            const data = await response.json();

            if (data.active) {
                isBotActive = true;
                btn.innerText = "üõë Stop Bot";
                btn.className = "w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded transition mb-2";
                document.getElementById('live-indicator').classList.remove('hidden');
                document.getElementById('live-ticker-display').innerText = `LIVE: ${ticker} (${paper ? 'PAPER' : 'REAL'})`;
                startPolling();
            } else {
                isBotActive = false;
                btn.innerText = "‚ñ∂Ô∏è Start Bot";
                btn.className = "w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded transition mb-2";
                document.getElementById('live-indicator').classList.add('hidden');
                stopPolling();
            }
        }

        function startPolling() {
            if(livePoller) clearInterval(livePoller);
            livePoller = setInterval(async () => {
                const res = await fetch('/get_live_status');
                const data = await res.json();
                
                // Update Logs
                const logBox = document.getElementById('live-logs');
                // Simple append strategy for now (clearing it creates flicker)
                // In production, you'd verify IDs. Here we just dump reverse.
                logBox.innerHTML = data.logs.slice().reverse().map(l => `<div class="log-entry"><span class="text-gray-400">${l}</span></div>`).join('');
                
                // Update Heartbeat
                if(data.last_update) {
                    document.getElementById('bot-hb').innerText = `Last: ${data.last_update}`;
                }
            }, 2000); // Poll every 2 seconds
        }

        function stopPolling() {
            if(livePoller) clearInterval(livePoller);
        }

        // --- SHARED RENDERERS ---
        function renderLogs(logs, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            const tradeLogs = logs.filter(l => ['buy', 'profit', 'loss', 'force'].includes(l.type));
            tradeLogs.slice(-15).forEach(log => {
                let color = "text-gray-300";
                if(log.type === 'buy') color = "log-buy";
                if(log.type === 'profit') color = "log-profit";
                if(log.type === 'loss') color = "log-loss";
                
                container.innerHTML += `<div class="log-entry"><span class="log-date">${log.date}</span><span class="${color}">${log.msg}</span></div>`;
            });
        }

        function renderBalance(balances) {
            if(!balances || balances.length === 0) return;
            const final = balances[balances.length - 1];
            const start = balances[0] || 25000;
            const pct = ((final - start) / start) * 100;
            
            const balEl = document.getElementById('final-balance-display');
            const pctEl = document.getElementById('final-pct-display');
            const box = document.getElementById('balance-box');
            
            if(pct >= 0) {
                balEl.className = "text-2xl font-bold text-green-400";
                pctEl.className = "text-sm font-bold text-green-600";
                box.className = "bg-slate-900 p-4 rounded-lg border border-green-900 mt-4 text-center";
            } else {
                balEl.className = "text-2xl font-bold text-red-500";
                pctEl.className = "text-sm font-bold text-red-700";
                box.className = "bg-slate-900 p-4 rounded-lg border border-red-900 mt-4 text-center";
            }
            
            balEl.innerText = `$${final.toFixed(2)}`;
            pctEl.innerText = `(${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%)`;
            box.classList.remove('hidden');
        }

        function renderChart(data) {
            const startBal = data.bot_balance[0] || 25000;
            const endBal = data.bot_balance[data.bot_balance.length - 1];
            const lineColor = endBal >= startBal ? '#10b981' : '#ef4444';

            const trace1 = { x: data.dates, y: data.stock_price, type: 'scatter', name: 'Price', line: { color: '#64748b' } };
            const trace2 = { x: data.dates, y: data.bot_balance, type: 'scatter', name: 'Balance', yaxis: 'y2', line: { color: lineColor } };
            
            const layout = {
                paper_bgcolor: '#1e293b', plot_bgcolor: '#1e293b', font: { color: '#94a3b8' },
                margin: { t: 30, b: 30, l: 40, r: 40 },
                xaxis: { showgrid: false },
                yaxis: { showgrid: true, gridcolor: '#334155' },
                yaxis2: { overlaying: 'y', side: 'right', showgrid: false },
                showlegend: false
            };
            Plotly.newPlot('chart', [trace1, trace2], layout);
        }
    </script>
</body>
</html>