<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Trade Robinhood</title>
       <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
 
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .terminal-logs {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
            font-size: 0.9rem;
        }
        .log-buy { color: #4ade80; font-weight: bold; }
        .log-profit { color: #38bdf8; font-weight: bold; }
        .log-loss { color: #f87171; font-weight: bold; }
        .log-force { color: #fbbf24; font-weight: bold; }
        .log-forecast { 
            color: #d8b4fe; font-weight: bold; 
            border: 1px solid #a855f7; padding: 2px 6px; border-radius: 4px;
            background: rgba(168, 85, 247, 0.1); display: inline-block; margin-top: 5px;
        }
        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #3b82f6; margin-top: -6px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }
    </style>
</head>
<body class="p-6">

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-blue-400">üß† Neural Trade Dashboard</h1>
            <p class="text-gray-400 text-sm">Robinhood API ‚Ä¢ Random Forest ‚Ä¢ Council of Strategies</p>
        </div>
        <div class="flex gap-4 text-right">
            <div class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                <span class="text-xs text-gray-500 uppercase">Buying Power</span>
                <div id="header-cash" class="font-bold text-white text-lg">---</div>
            </div>
            <div id="connection-status" class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                <span class="text-xs text-gray-500 uppercase">Token Status</span>
                <div class="font-bold text-green-400">{{ token_status }}</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6">
        <div class="col-span-3 space-y-4">
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <h3 class="font-bold text-gray-300 mb-2">1. Settings</h3>
                <label class="block text-xs text-gray-500 mb-1">TICKER</label>
                <input type="text" id="ticker-input" value="INTC" class="w-full bg-slate-900 border border-slate-600 rounded p-2 mb-3 text-white font-mono uppercase">
                <label class="block text-xs text-gray-500 mb-1">MODE</label>
                <select id="sim-mode" onchange="updateUI()" class="w-full bg-slate-900 border border-slate-600 rounded p-2 mb-3 text-white">
                    <option value="swing">üåä Swing (Daily)</option>
                    <option value="day">‚òÄÔ∏è Day (5-Min)</option>
                </select>
                
                <label class="block text-xs text-gray-500 mb-1 flex justify-between">
                    <span>TRAINING DATA SIZE</span>
                    <span id="train-display" class="text-blue-400 font-bold">365 Days</span>
                </label>
                <input type="range" id="train-slider" min="30" max="700" value="365" oninput="updateLabels()" class="w-full mb-3">
                
                <label class="block text-xs text-gray-500 mb-1 flex justify-between">
                    <span>SIMULATION DURATION</span>
                    <span id="test-display" class="text-purple-400 font-bold">10 Days</span>
                </label>
                <input type="range" id="test-slider" min="5" max="200" value="10" oninput="updateLabels()" class="w-full mb-1">
                <p class="text-[10px] text-gray-500 mb-3" id="test-desc">Run simulation on the last 10 days.</p>
                
                <label class="block text-xs text-gray-500 mb-1 flex justify-between">
                    <span>MIN CONFIDENCE</span>
                    <span id="conf-display" class="text-green-400 font-bold">51%</span>
                </label>
                <input type="range" id="conf-slider" min="40" max="90" value="51" oninput="updateLabels()" class="w-full mb-1">
                <p class="text-[10px] text-gray-500 mb-1">Lower = More Trades. Higher = Safer.</p>

            </div>

            <button onclick="runSimulation()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition border border-blue-500">
                üî¨ Run Backtest
            </button>

            <div class="bg-slate-900 p-4 rounded-lg border border-indigo-900">
                <h3 class="font-bold text-indigo-400 mb-2">2. Live Bot Control</h3>
                
                <div class="mb-3">
                    <label class="block text-xs text-gray-400 mb-1">TRADE AMOUNT ($)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" id="trade-amount" value="10" min="1" 
                            class="w-full bg-slate-800 border border-slate-700 rounded p-2 pl-6 text-white font-mono">
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm text-gray-400">Paper Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="paper-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>

                <button id="btn-start" onclick="toggleLiveBot()" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded transition mb-2">
                    ‚ñ∂Ô∏è Start Bot
                </button>
                
                <div id="live-indicator" class="hidden mt-2 text-center">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full status-pulse mr-2"></span>
                    <span class="text-xs text-red-400 font-mono" id="live-ticker-display">LIVE: INTC</span>
                </div>
            </div>

            <div id="balance-box" class="hidden bg-slate-900 p-4 rounded-lg border mt-4 text-center">
                <div class="text-gray-400 text-xs uppercase">Simulated Final Balance</div>
                <div id="final-balance-display" class="text-2xl font-bold">---</div>
                <div id="final-pct-display" class="text-sm font-bold">---</div>
            </div>
        </div>

        <div class="col-span-9 bg-slate-800 rounded-lg border border-slate-700 p-1">
            <div id="chart" class="w-full h-[400px]"></div>
        </div>

        <div class="col-span-12">
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 flex gap-4">
                <div class="w-1/2">
                    <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">Backtest Log</h3>
                    <div id="log-container" class="terminal-logs">
                        <div class="text-gray-500 italic">Waiting for simulation...</div>
                    </div>
                </div>
                <div class="w-1/2">
                    <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider flex justify-between">
                        <span>Live Bot Stream</span>
                        <span id="bot-hb" class="text-xs font-normal text-gray-600">Heartbeat: ---</span>
                    </h3>
                    <div id="live-logs" class="terminal-logs border-indigo-900 bg-[#161b22]">
                        <div class="text-gray-600 italic">Bot is offline.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateUI() {
            const mode = document.getElementById('sim-mode').value;
            const trainSlider = document.getElementById('train-slider');
            const testSlider = document.getElementById('test-slider');

            if(mode === 'day') {
                trainSlider.max = 50; trainSlider.value = 30; trainSlider.min = 5;
                testSlider.max = 72; testSlider.value = 4; // Hours
            } else {
                trainSlider.max = 700; trainSlider.value = 365; trainSlider.min = 60;
                testSlider.max = 200; testSlider.value = 10; // Days
            }
            updateLabels();
        }

        function updateLabels() {
            // ROBUST SAFETY CHECK
            const trainDisplay = document.getElementById('train-display');
            const testDisplay = document.getElementById('test-display');
            const confDisplay = document.getElementById('conf-display');
            const testDesc = document.getElementById('test-desc');

            // If ANY element is missing, stop immediately to avoid crash
            if (!trainDisplay || !testDisplay || !confDisplay || !testDesc) return;

            const mode = document.getElementById('sim-mode').value;
            const trainVal = document.getElementById('train-slider').value;
            const testVal = document.getElementById('test-slider').value;
            const confVal = document.getElementById('conf-slider').value;

            trainDisplay.innerText = `${trainVal} Days`;
            confDisplay.innerText = `${confVal}%`;
            
            if (mode === 'day') {
                testDisplay.innerText = `${testVal} Hours`;
                testDesc.innerText = `Simulate trading over the last ${testVal} hours.`;
            } else {
                testDisplay.innerText = `${testVal} Days`;
                testDesc.innerText = `Simulate trading over the last ${testVal} days.`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            updateUI(); 
            try {
                const res = await fetch('/get_balance');
                const data = await res.json();
                if(data.success) {
                    const formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(data.cash);
                    document.getElementById('header-cash').innerText = formatted;
                }
            } catch(e) { document.getElementById('header-cash').innerText = "Offline"; }
        });

        async function runSimulation() {
            const ticker = document.getElementById('ticker-input').value;
            const mode = document.getElementById('sim-mode').value;
            const train_days = document.getElementById('train-slider').value;
            const test_days = document.getElementById('test-slider').value;
            const min_conf = document.getElementById('conf-slider').value;
            
            const logBox = document.getElementById('log-container');

            logBox.innerHTML = '<div class="text-blue-400 animate-pulse">Running Simulation...</div>';

            try {
                const response = await fetch('/run_sim', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ticker: ticker, 
                        mode: mode, 
                        train_days: train_days, 
                        test_days: test_days,
                        min_conf: min_conf
                    })
                });
                const data = await response.json();
                
                if (data.error) {
                    logBox.innerHTML = `<div class="text-red-500">Error: ${data.error}</div>`;
                    return;
                }
                renderLogs(data.logs, 'log-container');
                renderBalance(data.bot_balance);
                renderChart(data);
            } catch (e) { logBox.innerHTML = `<div class="text-red-500">Error: ${e}</div>`; }
        }

        function renderLogs(logs, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            const tradeLogs = logs.filter(l => ['buy', 'profit', 'loss', 'force', 'forecast'].includes(l.type));
            const last15 = tradeLogs.slice(-15);
            
            last15.forEach(log => {
                let color = "text-gray-300";
                if(log.type === 'buy') color = "log-buy";
                if(log.type === 'profit') color = "log-profit";
                if(log.type === 'loss') color = "log-loss";
                
                if(log.type === 'forecast') {
                    container.innerHTML += `<div class="log-entry"><span class="log-forecast">${log.msg}</span></div>`;
                } else {
                    container.innerHTML += `<div class="log-entry"><span class="log-date">${log.date}</span><span class="${color}">${log.msg}</span></div>`;
                }
            });
        }
        
        let livePoller = null;
        let isBotActive = false;

        async function toggleLiveBot() {
            const btn = document.getElementById('btn-start');
            const ticker = document.getElementById('ticker-input').value;
            const mode = document.getElementById('sim-mode').value;
            const paper = document.getElementById('paper-toggle').checked;
            
            // NEW: Get the amount
            const amount = document.getElementById('trade-amount').value; 
            
            const action = isBotActive ? 'stop' : 'start';

            const response = await fetch('/toggle_trading', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: action, 
                    ticker: ticker, 
                    mode: mode, 
                    paper: paper,
                    amount: amount  // <--- Send it here
                })
            });
            const data = await response.json();

            if (data.active) {
                isBotActive = true;
                btn.innerText = "üõë Stop Bot";
                btn.className = "w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded transition mb-2";
                document.getElementById('live-indicator').classList.remove('hidden');
                document.getElementById('live-ticker-display').innerText = `LIVE: ${ticker} (${paper ? 'PAPER' : 'REAL'})`;
                startPolling();
            } else {
                isBotActive = false;
                btn.innerText = "‚ñ∂Ô∏è Start Bot";
                btn.className = "w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded transition mb-2";
                document.getElementById('live-indicator').classList.add('hidden');
                stopPolling();
            }
        }

        function startPolling() {
            if(livePoller) clearInterval(livePoller);
            livePoller = setInterval(async () => {
                const res = await fetch('/get_live_status');
                const data = await res.json();
                
                const logBox = document.getElementById('live-logs');
                logBox.innerHTML = data.logs.slice().reverse().map(l => `<div class="log-entry"><span class="text-gray-400">${l}</span></div>`).join('');
                
                if(data.last_update) {
                    document.getElementById('bot-hb').innerText = `Last: ${data.last_update}`;
                }
            }, 2000); 
        }

        function stopPolling() {
            if(livePoller) clearInterval(livePoller);
        }

        function renderBalance(balances) {
            if(!balances || balances.length === 0) return;
            const final = balances[balances.length - 1];
            const start = balances[0] || 25000;
            const pct = ((final - start) / start) * 100;
            
            const balEl = document.getElementById('final-balance-display');
            const pctEl = document.getElementById('final-pct-display');
            const box = document.getElementById('balance-box');
            
            if(pct >= 0) {
                balEl.className = "text-2xl font-bold text-green-400";
                pctEl.className = "text-sm font-bold text-green-600";
                box.className = "bg-slate-900 p-4 rounded-lg border border-green-900 mt-4 text-center";
            } else {
                balEl.className = "text-2xl font-bold text-red-500";
                pctEl.className = "text-sm font-bold text-red-700";
                box.className = "bg-slate-900 p-4 rounded-lg border border-red-900 mt-4 text-center";
            }
            
            balEl.innerText = `$${final.toFixed(2)}`;
            pctEl.innerText = `(${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%)`;
            box.classList.remove('hidden');
        }

        function renderChart(data) {
            const startBal = data.bot_balance[0] || 25000;
            const endBal = data.bot_balance[data.bot_balance.length - 1];
            const lineColor = endBal >= startBal ? '#10b981' : '#ef4444';

            const trace1 = { x: data.dates, y: data.stock_price, type: 'scatter', name: 'Price', line: { color: '#64748b' } };
            const trace2 = { x: data.dates, y: data.bot_balance, type: 'scatter', name: 'Balance', yaxis: 'y2', line: { color: lineColor } };
            
            const layout = {
                paper_bgcolor: '#1e293b', plot_bgcolor: '#1e293b', font: { color: '#94a3b8' },
                margin: { t: 30, b: 30, l: 40, r: 40 },
                xaxis: { showgrid: false },
                yaxis: { showgrid: true, gridcolor: '#334155' },
                yaxis2: { overlaying: 'y', side: 'right', showgrid: false },
                showlegend: false
            };
            Plotly.newPlot('chart', [trace1, trace2], layout);
        }
    </script>
</body>
</html>