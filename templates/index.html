<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Trade Robinhood</title>
    <script>
        const originalWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .terminal-logs {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #334155;
            font-size: 0.9rem;
        }
        .log-entry { margin-bottom: 4px; display: flex; }
        .log-date { color: #94a3b8; margin-right: 10px; min-width: 140px; }
        
        /* Log Colors */
        .log-buy { color: #4ade80; font-weight: bold; }   /* Green */
        .log-profit { color: #38bdf8; font-weight: bold; } /* Blue */
        .log-loss { color: #f87171; font-weight: bold; }   /* Red */
        .log-force { color: #fbbf24; font-weight: bold; }  /* Amber */
    </style>
</head>
<body class="p-6">

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-blue-400">üß† Neural Trade Dashboard</h1>
            <p class="text-gray-400 text-sm">Robinhood API ‚Ä¢ Random Forest ‚Ä¢ Council of Strategies</p>
        </div>
        <div class="text-right">
            <div id="connection-status" class="bg-gray-800 px-4 py-2 rounded-lg border border-gray-700">
                <span class="text-xs text-gray-500 uppercase">Token Status</span>
                <div class="font-bold text-green-400">{{ token_status }}</div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6">
        
        <div class="col-span-3 space-y-4">
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <h3 class="font-bold text-gray-300 mb-2">Strategy Mode</h3>
                <select id="sim-mode" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white">
                    <option value="swing">üåä Swing Trading (Daily)</option>
                    <option value="day">‚òÄÔ∏è Day Trading (5-Min)</option>
                </select>
            </div>

            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                <label class="block text-sm text-gray-400 mb-1">Ticker</label>
                <input type="text" id="ticker-input" value="INTC" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white font-mono uppercase">
            </div>

            <button onclick="runSimulation()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">
                üî¨ Run Simulation
            </button>

            <div id="balance-box" class="hidden bg-slate-900 p-4 rounded-lg border mt-4 text-center transition-colors">
                <div class="text-gray-400 text-xs uppercase">Final Balance</div>
                <div id="final-balance-display" class="text-2xl font-bold">---</div>
                <div id="final-pct-display" class="text-sm font-bold">---</div>
            </div>
        </div>

        <div class="col-span-9 bg-slate-800 rounded-lg border border-slate-700 p-1">
            <div id="chart" class="w-full h-[400px]"></div>
        </div>

        <div class="col-span-12">
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
                <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">Trade Log (Last 15)</h3>
                <div id="log-container" class="terminal-logs">
                    <div class="text-gray-500 italic">Waiting for simulation...</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        async function runSimulation() {
            const ticker = document.getElementById('ticker-input').value;
            const mode = document.getElementById('sim-mode').value;
            const logBox = document.getElementById('log-container');
            const balBox = document.getElementById('balance-box');

            logBox.innerHTML = '<div class="text-blue-400 animate-pulse">Running Simulation... this may take a moment.</div>';

            try {
                const response = await fetch('/run_sim', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: ticker, mode: mode })
                });

                const data = await response.json();
                if (data.error) {
                    logBox.innerHTML = `<div class="text-red-500">Error: ${data.error}</div>`;
                    return;
                }

                // Render components with new data
                renderLogs(data.logs);
                renderBalance(data.bot_balance);
                renderChart(data); // Pass full data to chart for color logic

            } catch (e) {
                logBox.innerHTML = `<div class="text-red-500">Network Error: ${e}</div>`;
            }
        }

        function renderLogs(logs) {
            const container = document.getElementById('log-container');
            container.innerHTML = "";

            // 1. Filter: Only show Trades (Buy/Profit/Loss/Force)
            const tradeLogs = logs.filter(l => ['buy', 'profit', 'loss', 'force'].includes(l.type));

            // 2. Slice: Get only the last 15
            const last15 = tradeLogs.slice(-15);

            last15.forEach(log => {
                const row = document.createElement('div');
                row.className = "log-entry";
                
                // Color Logic
                let typeClass = "text-gray-300";
                if(log.type === 'buy') typeClass = "log-buy";
                if(log.type === 'profit') typeClass = "log-profit";
                if(log.type === 'loss') typeClass = "log-loss";
                if(log.type === 'force') typeClass = "log-force";

                row.innerHTML = `
                    <span class="log-date">${log.date}</span>
                    <span class="${typeClass}">${log.msg}</span>
                `;
                container.appendChild(row);
            });

            // System Message
            const sysRow = document.createElement('div');
            sysRow.className = "mt-4 text-purple-400 font-bold border-t border-gray-700 pt-2";
            sysRow.innerText = "SYSTEM üß† Final Brain Saved for Live Trading";
            container.appendChild(sysRow);
        }

        function renderBalance(balances) {
            if(!balances || balances.length === 0) return;
            const finalBal = balances[balances.length - 1];
            const startBal = balances[0] || 25000; 
            const pct = ((finalBal - startBal) / startBal) * 100;

            const balEl = document.getElementById('final-balance-display');
            const pctEl = document.getElementById('final-pct-display');
            const boxEl = document.getElementById('balance-box');

            // --- COLOR LOGIC ---
            if (pct >= 0) {
                // PROFIT: Green Text, Dark Green Border
                balEl.className = "text-2xl font-bold text-green-400";
                pctEl.className = "text-sm font-bold text-green-600";
                boxEl.className = "bg-slate-900 p-4 rounded-lg border border-green-900 mt-4 text-center";
                pctEl.innerText = `(+${pct.toFixed(2)}%)`;
            } else {
                // LOSS: Red Text, Dark Red Border
                balEl.className = "text-2xl font-bold text-red-500";
                pctEl.className = "text-sm font-bold text-red-700";
                boxEl.className = "bg-slate-900 p-4 rounded-lg border border-red-900 mt-4 text-center";
                pctEl.innerText = `(${pct.toFixed(2)}%)`;
            }

            balEl.innerText = `$${finalBal.toFixed(2)}`;
            boxEl.classList.remove('hidden');
        }

        function renderChart(data) {
            const startBalance = data.bot_balance[0] || 25000;
            const finalBalance = data.bot_balance[data.bot_balance.length - 1];
            
            // If Final Balance is Profit -> Green Line
            // If Final Balance is Loss -> Red Line
            const isProfit = finalBalance >= startBalance;
            const mainLineColor = isProfit ? '#10b981' : '#ef4444'; 

            const trace1 = {
                x: data.dates,
                y: data.stock_price,
                type: 'scatter',
                mode: 'lines',
                name: 'Price',
                line: { color: '#64748b', width: 1 }
            };

            const trace2 = {
                x: data.dates,
                y: data.bot_balance,
                type: 'scatter',
                mode: 'lines',
                name: 'Balance',
                yaxis: 'y2',
                // Dynamic Color applied here
                line: { color: mainLineColor, width: 2 }
            };

            const layout = {
                paper_bgcolor: '#1e293b',
                plot_bgcolor: '#1e293b',
                font: { color: '#94a3b8' },
                margin: { t: 30, b: 30, l: 40, r: 40 },
                xaxis: { showgrid: false },
                yaxis: { showgrid: true, gridcolor: '#334155' },
                yaxis2: {
                    title: 'Balance',
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false
                },
                showlegend: true,
                legend: { x: 0, y: 1 },
                // Add a "Break Even" dashed line
                shapes: [{
                    type: 'line',
                    xref: 'paper', x0: 0, x1: 1,
                    yref: 'y2', y0: startBalance, y1: startBalance,
                    line: {
                        color: '#94a3b8',
                        width: 1,
                        dash: 'dot'
                    }
                }]
            };

            Plotly.newPlot('chart', [trace1, trace2], layout);
        }
    </script>
</body>
</html>